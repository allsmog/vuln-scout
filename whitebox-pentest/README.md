# Whitebox Pentest Plugin

A comprehensive whitebox penetration testing plugin for Claude Code based on industry-standard methodologies from **HTB Academy** and **OffSec AWAE/OSWE**.

## Overview

This plugin guides security researchers through systematic source code analysis and vulnerability discovery using the proven 4-phase whitebox pentesting process:

1. **Code Review** - Static analysis to identify dangerous functions and prioritize targets
2. **Local Testing** - Dynamic analysis, debugging, and exploitation confirmation
3. **Proof of Concept** - Full chain exploitation and exploit script development
4. **Patching & Remediation** - Secure code fixes and reporting

## Features

### Skills (15 Auto-Activated)
- **dangerous-functions** - Database of security-sensitive functions by language
- **vuln-patterns** - Common vulnerability patterns: SQLi, XSS, Command Injection, Path Traversal, Deserialization, SSTI
- **data-flow-tracing** - Techniques for tracing user input from sources to sinks
- **exploit-techniques** - PoC development patterns and language-specific templates
- **sensitive-data-leakage** - Detect credentials/secrets flowing to logs, errors, or HTTP responses (CWE-532)
- **business-logic** - Workflow vulnerabilities, trust boundary analysis, and state machine bugs
- **threat-modeling** - STRIDE methodology, data flow diagramming, and systematic threat identification
- **cpg-analysis** - Code Property Graph analysis with Joern/CPGQL for data flow verification
- **mixed-language-monorepos** - Cross-service security for polyglot codebases (Go + Python + TypeScript, etc.)
- **owasp-2025** - Master mapping of OWASP Top 10 2025 categories with CWE cross-references
- **security-misconfiguration** - Debug mode, default credentials, missing headers (A02)
- **cryptographic-failures** - Weak algorithms, hardcoded secrets, insecure random (A04)
- **logging-failures** - Log injection, insufficient logging, secrets in logs (A09)
- **exception-handling** - XXE, error disclosure, improper exception handling (A10)
- **workspace-discovery** - Detect monorepo workspaces, packages, and module boundaries

### Commands (9 total)

| Command | Description |
|---------|-------------|
| `/whitebox-pentest:full-audit [path]` | **Main entry point** - auto-scopes, threat models, audits high-risk modules |
| `/whitebox-pentest:scope [path]` | Create focused scope for large codebases, list workspaces (`--list`) |
| `/whitebox-pentest:threats` | Application understanding + STRIDE threat modeling |
| `/whitebox-pentest:sinks [language]` | Search for dangerous functions, auto-discover patterns (`--discover`) |
| `/whitebox-pentest:trace <function>` | Trace data flow to/from a specific function |
| `/whitebox-pentest:scan [path]` | Security scan with Semgrep, CodeQL, Joern (`--tools`) |
| `/whitebox-pentest:verify <file:line>` | Verify findings using CPG data flow analysis |
| `/whitebox-pentest:propagate <pattern>` | Find all instances of a vulnerability pattern |
| `/whitebox-pentest:report [output_file]` | Generate findings report in Markdown |

### Agents (7 Autonomous Analysts)
- **app-mapper** - Application architecture and trust boundary mapping
- **threat-modeler** - STRIDE analysis, data flow diagrams, and systematic threat identification
- **code-reviewer** - Proactive static analysis for vulnerability identification
- **local-tester** - Dynamic testing and exploitation guidance
- **poc-developer** - Exploit script development assistance
- **patch-advisor** - Remediation recommendations with specific code patches
- **false-positive-verifier** - Chain-of-thought verification to eliminate false positives

### Hooks (4 Background Automation)
- **session-init** - Initialize pentest session and check for previous state
- **large-codebase-check** - Suggests scoping before expensive operations on large codebases
- **poc-safety-check** - Safety confirmation before PoC development begins
- **suggest-next-phase** - Suggests next phase when code review findings are identified

## Installation

```bash
# Clone or copy to your plugins directory
claude --plugin-dir /path/to/whitebox-pentest

# Or add to project
cp -r whitebox-pentest /your/project/.claude-plugins/
```

## Usage

### Full Audit (Recommended Start)
```bash
/whitebox-pentest:full-audit /path/to/code
```
**One command does everything**: auto-detects codebase size, creates compressed architecture scope for large codebases, generates threat model, identifies high-risk modules, and audits them with architecture context.

### Quick Audit (Skip Threat Modeling)
```bash
/whitebox-pentest:full-audit --quick
```

### Focus on Recent Git Changes
```bash
/whitebox-pentest:full-audit --recent 30
```
Prioritizes modules with changes in the last 30 days.

### Large Codebase Workflow
```bash
# List available workspaces/packages
/whitebox-pentest:scope --list

# Create compressed architecture scope (Go: 97% reduction, TS: 80%)
/whitebox-pentest:scope . --compress --name architecture

# Run threat modeling on compressed scope
/whitebox-pentest:threats --scope architecture --save .claude/threat-model.md
```

### Quick Sink Search
```bash
/whitebox-pentest:sinks go
/whitebox-pentest:sinks --discover  # Auto-discover logging patterns first
```

### Find Similar Patterns
```bash
/whitebox-pentest:propagate src/api/users.py:45
```
When you find one bug, find all similar instances.

### Generate Report
```bash
/whitebox-pentest:report security-report.md
```

## Supported Languages

| Language | Compression | Tools |
|----------|-------------|-------|
| Go | 95-97% | Semgrep, Joern |
| TypeScript/JS | ~80% | Semgrep, CodeQL |
| Python | 85-90% | Semgrep, Joern |
| Java | 80-85% | Semgrep, CodeQL |
| Rust | 85-90% | Semgrep |
| PHP | 80-85% | Semgrep |
| C#/.NET | 80-85% | Semgrep, CodeQL |
| Ruby | 85-90% | Semgrep |
| **Solidity** | 70-80% | Semgrep, Slither |

See `skills/dangerous-functions/` for complete lists of security-sensitive functions per language.

## Vulnerability Coverage

- **Injection**: SQL, Command, LDAP, Template (SSTI)
- **Authentication**: Bypass, Session attacks, JWT flaws
- **Access Control**: IDOR, Privilege escalation
- **Business Logic**: Workflow bypass, State manipulation, Trust boundary violations
- **Cryptography**: Weak algorithms, Hardcoded secrets
- **Deserialization**: Java, PHP, Python, .NET gadgets
- **Race Conditions**: TOCTOU, Double-spend attacks
- **Data Leakage**: Credentials in logs, Error exposure
- **Smart Contracts**: Reentrancy, Flash loans, Oracle manipulation, Access control, Integer overflow

## OWASP Top 10 2025 Coverage

| Category | Coverage | Skill |
|----------|----------|-------|
| A01: Broken Access Control | ✅ Full | `business-logic` |
| A02: Security Misconfiguration | ✅ Full | `security-misconfiguration` |
| A03: Software Supply Chain | ⏭️ Skip | *(out of scope)* |
| A04: Cryptographic Failures | ✅ Full | `cryptographic-failures` |
| A05: Injection | ✅ Full | `vuln-patterns`, `dangerous-functions` |
| A06: Insecure Design | ✅ Full | `business-logic`, `threat-modeling` |
| A07: Authentication Failures | ✅ Full | `vuln-patterns` |
| A08: Data Integrity Failures | ✅ Full | `vuln-patterns` |
| A09: Logging & Alerting | ✅ Full | `logging-failures`, `sensitive-data-leakage` |
| A10: Exception Mishandling | ✅ Full | `exception-handling` |

**Coverage**: 9/10 categories (A03 Supply Chain excluded by design)

## Methodology

This plugin implements methodologies from:
- **HTB Academy** - Whitebox Pentesting Process
- **OffSec AWAE** - Advanced Web Attacks and Exploitation (WEB-300)
- **NahamSec** - Deep application understanding and business logic focus

### Philosophy

> "Understanding the application deeply will always beat automation."

The plugin supports two complementary approaches:

1. **Sink-First**: Traditional approach - find dangerous functions, trace data flow
2. **Understanding-First**: Use `/whitebox-pentest:threats --quick` to map the application before hunting

Both approaches work together. Understanding reveals business logic bugs that sink scanning misses.

### Recommended Workflow

**For any codebase (simple):**
```bash
/whitebox-pentest:full-audit
```

**For large codebases (manual control):**
```bash
1. /whitebox-pentest:scope --list           # See available modules
2. /whitebox-pentest:scope . --compress     # Create architecture scope
3. /whitebox-pentest:threats --scope arch   # Generate threat model
4. /whitebox-pentest:sinks go               # Find dangerous functions
5. /whitebox-pentest:trace <sink>           # Trace high-severity threats
6. /whitebox-pentest:propagate <pattern>    # Find similar patterns
7. /whitebox-pentest:report                 # Generate findings report
```

### The 4-Phase Process

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Code Review   │───▶│  Local Testing  │───▶│  Proof of       │───▶│  Patching &     │
│                 │    │                 │    │  Concept        │    │  Remediation    │
│ - Find sinks    │    │ - Debug locally │    │ - Full chain    │    │ - Code patches  │
│ - Trace flow    │    │ - Confirm vuln  │    │ - Write exploit │    │ - Secure coding │
│ - Prioritize    │    │ - Basic exploit │    │ - Test on target│    │ - Report        │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Multi-Tool Scanning

Combine multiple static analysis tools for better coverage:

```bash
/whitebox-pentest:scan /path/to/code --tools semgrep,joern
/whitebox-pentest:scan contracts/ --tools semgrep  # Solidity
```

### Supported Tools

| Tool | Install | Strengths |
|------|---------|-----------|
| Semgrep | `pip install semgrep` | Fast pattern matching, low false positives |
| CodeQL | [GitHub releases](https://github.com/github/codeql-cli-binaries) | Deep taint tracking, language-specific |
| Joern | `curl -L .../joern-install.sh \| bash` | CPG analysis, custom queries |
| **Slither** | `pip install slither-analyzer` | **Solidity smart contracts** |

### Output

Findings from all tools are merged into a unified format with deduplication.

## Large Codebase Support

The plugin handles large codebases (tested on 1.68M token Go monorepos) via language-aware compression.

### Prerequisites

```bash
npm install -g repomix  # Required for scoping
```

### How It Works

`/full-audit` automatically:
1. Detects codebase size (token count)
2. If >150k tokens, creates compressed architecture scope
3. Uses language-aware compression:
   - **Go**: Directory-based filtering → **95-97% reduction**
   - **TypeScript/JS**: Tree-sitter → **~80% reduction**
   - **Python**: Framework-aware (Django/Flask/FastAPI) → **85-90% reduction**
   - **Java**: Spring pattern filtering → **80-85% reduction**
   - **Rust**: Module-based filtering → **85-90% reduction**
   - **PHP**: Laravel/Symfony patterns → **80-85% reduction**
   - **C#/.NET**: ASP.NET Core patterns → **80-85% reduction**
   - **Ruby**: Rails patterns → **85-90% reduction**
   - **Solidity**: Contract filtering → **70-80% reduction**

### Manual Workflow

```bash
# List workspaces/modules with size estimates
/whitebox-pentest:scope --list

# Create compressed architecture scope
/whitebox-pentest:scope . --compress --name architecture

# Create full scope for specific module
/whitebox-pentest:scope query-service --name qs

# Scan specific module
/whitebox-pentest:scan --workspace api
```

### Supported Monorepo Types

Auto-detects: npm/yarn/pnpm workspaces, Go modules (`go.work`), Maven/Gradle, Rust workspaces, Python packages.

## Mixed-Language (Polyglot) Monorepo Support

Modern architectures often use multiple languages: Go APIs, Python ML services, TypeScript frontends, Java data processors. This plugin handles these polyglot codebases with per-service analysis and cross-service security verification.

### Polyglot Audit
```bash
/whitebox-pentest:full-audit ~/code/platform
# Automatically detects mixed-language codebase
```

### What Polyglot Mode Does

1. **Detects all languages** in the codebase
2. **Maps services to languages** (identifies Go services, Python services, etc.)
3. **Scopes each service** with language-appropriate compression
4. **Generates cross-service threat model** with trust boundaries between services
5. **Audits services in priority order** (auth first, then APIs, then ML)
6. **Verifies cross-service vulnerabilities**:
   - Auth token propagation gaps
   - Input validation assumptions between services
   - Error message information leakage
   - Schema mismatches (proto/OpenAPI)

### Cross-Service Security Patterns

| Pattern | Risk | Detection |
|---------|------|-----------|
| **Gateway Bypass** | Attacker calls internal service directly | Service exposure checks |
| **Auth Token Confusion** | Different services interpret tokens differently | Header/JWT pattern analysis |
| **Serialization Mismatch** | Language differences in JSON/proto handling | Schema comparison |
| **Type Coercion** | Go strict typing vs Python duck typing | Cross-boundary type flows |
| **Error Leakage** | Python errors leak through Go gateway | Error handling patterns |

### Manual Polyglot Workflow
```bash
# 1. Discover service architecture (auto-detects polyglot)
/whitebox-pentest:scope --list

# 2. Scope each service with language-appropriate strategy
/whitebox-pentest:scope services/auth --language go --name auth
/whitebox-pentest:scope services/ml --language python --name ml
/whitebox-pentest:scope apps/web --language typescript --name web

# 3. Generate cross-service threat model
/whitebox-pentest:threats --save .claude/threat-model.md

# 4. Audit each service
/whitebox-pentest:full-audit --scope auth
/whitebox-pentest:full-audit --scope ml

# 5. Verify cross-service flows
/whitebox-pentest:trace gateway:handleRequest -> ml:predict
```

### Example Output

```
╔═══════════════════════════════════════════════════════════════╗
║                 POLYGLOT AUDIT COMPLETE                       ║
╠═══════════════════════════════════════════════════════════════╣
║  Languages: Go (450 files), Python (380), TypeScript (420)    ║
║  Services audited: 5                                          ║
║                                                                ║
║  Findings by Service:                                         ║
║  ├── auth-service (Go): 2 CRITICAL, 1 HIGH                   ║
║  ├── api-gateway (Go): 1 HIGH, 2 MEDIUM                      ║
║  ├── ml-pipeline (Python): 1 CRITICAL, 2 HIGH                ║
║  ├── web-frontend (TypeScript): 3 MEDIUM                     ║
║  └── data-processor (Java): 1 HIGH                           ║
║                                                                ║
║  Cross-Service Findings:                                      ║
║  ├── Auth token not validated in ml-pipeline (CRITICAL)      ║
║  ├── Error messages leak from Python to Gateway (MEDIUM)     ║
║  └── No mTLS between gateway and auth-service (HIGH)         ║
╚═══════════════════════════════════════════════════════════════╝
```

## License

MIT
