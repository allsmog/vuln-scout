---
name: trace
description: Trace data flow from sources to a specific sink
argument-hint: "<function_or_file:line>"
allowed-tools:
  - Glob
  - Grep
  - Read
---

# Data Flow Trace Command

Trace the flow of user-controlled data to a specified dangerous function or code location.

## Execution

### Step 1: Parse Target

Accept input in formats:
- `function_name` - Search for function and trace
- `file.php:42` - Trace from specific line
- `$variable` - Trace specific variable

### Step 2: Identify the Sink

Read the target file/line to understand:
- What function is being called
- What parameters are passed
- What the immediate context is

### Step 3: Backward Trace

For each parameter passed to the sink:

1. **Find Assignment**
   - Search for where the variable is assigned
   - Use Grep to find: `$varname =` or `varname =`

2. **Check Source**
   - Is it from user input? ($_GET, $_POST, request.*, etc.)
   - Is it from database? (query results)
   - Is it from file? (file reads)
   - Is it from function parameter? (trace caller)

3. **Document Transformations**
   - What functions process the data?
   - Is sanitization applied?
   - Can sanitization be bypassed?

### Step 4: Cross-File Tracing

If the source is in another file:
- Trace include/require statements
- Follow function calls across files
- Check session/global variable propagation

### Step 5: Output Report

```
## Data Flow Trace: [target]

### Sink
**File**: path/to/file.php
**Line**: 42
**Code**: `dangerous_function($param)`

### Trace Path

1. **Source** (path/to/file.php:10)
   ```php
   $param = $_GET['input'];
   ```
   Type: Direct user input (GET parameter)

2. **Transformation** (path/to/file.php:15)
   ```php
   $param = trim($param);
   ```
   Effect: Whitespace removal only

3. **Transformation** (path/to/file.php:20)
   ```php
   $param = str_replace("'", "", $param);
   ```
   Effect: Single quote removal
   Bypass: Use double quotes or encoding

4. **Sink** (path/to/file.php:42)
   ```php
   dangerous_function($param);
   ```

### Analysis

**User Controllable**: Yes
**Sanitization**: Partial (single quote removal)
**Bypass Possible**: Yes (use alternative characters)
**Exploitability**: Likely exploitable

### Recommendation

[Specific remediation advice]
```

## Notes

- Always show code context for each step
- Highlight potential bypass opportunities
- Note if trace is incomplete (dynamic calls, etc.)
- Suggest next steps (exploit development or more analysis)
