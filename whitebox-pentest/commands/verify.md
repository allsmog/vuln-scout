---
name: verify
description: Verify security findings using Joern CPG + Claude AI analysis - confirms data flow and eliminates false positives
argument-hint: "<file:line> [--type sql-injection|command-injection|xss|...] [--all-critical]"
allowed-tools:
  - Bash
  - Read
  - Write
  - Grep
  - Glob
  - TodoWrite
  - Task
---

# Two-Layer Verification Workflow

Verify security findings using a two-layer approach:
1. **Layer 1: Joern CPG** - Proves data flow exists (or doesn't)
2. **Layer 2: Claude AI** - Analyzes exploitability and false positive patterns

## Philosophy

> "Pattern matching finds potential bugs. CPG proves data flow. AI confirms exploitability."

This command bridges the gap between static analysis findings and confirmed vulnerabilities.

---

## Usage Modes

### Mode 1: Verify Specific Finding

```
/whitebox-pentest:verify routes/login.ts:34 --type sql-injection
```

Verifies a single finding at a specific location.

### Mode 2: Verify All Critical Findings

```
/whitebox-pentest:verify --all-critical
```

Reads threat model from `.claude/threat-model.md` and verifies all CRITICAL threats.

### Mode 3: Verify From SARIF/JSON

```
/whitebox-pentest:verify --from findings.sarif
```

Imports findings from Semgrep/CodeQL output and verifies each.

---

## Prerequisites

### Check Joern Installation (Required)

```bash
# Check if Joern is installed
joern --version 2>/dev/null && echo "Joern available" || echo "Joern not installed - see joern-setup.md"

# Check for existing CPG cache
ls -la .joern/*.cpg 2>/dev/null || echo "No CPG cache found"
```

If Joern is not available:
```
See: /whitebox-pentest:skills/cpg-analysis/references/joern-setup.md
```

### Detect Plugin Root

```bash
# Find plugin installation directory
PLUGIN_ROOT=""
for dir in ~/.claude/plugins/whitebox-pentest /usr/local/share/claude-plugins/whitebox-pentest "$(dirname "$0")"; do
  if [ -f "$dir/scripts/joern/common.sc" ]; then
    PLUGIN_ROOT="$dir"
    break
  fi
done

if [ -z "$PLUGIN_ROOT" ]; then
  echo "Warning: Plugin scripts not found. Using inline verification."
fi
```

---

## Verification Workflow

### Step 1: Parse Arguments

Determine verification mode:
- If `--all-critical`: Read threat model, extract CRITICAL findings
- If `--from <file>`: Parse SARIF/JSON file
- Otherwise: Parse `file:line` and `--type` arguments

### Step 2: Classify Finding Type

Determine if finding is CPG-verifiable or static:

**CPG-Verifiable** (data flow matters):
- SQL injection, NoSQL injection
- Command injection
- XSS
- Path traversal
- SSRF
- Deserialization

**Static Findings** (no data flow to verify):
- Hardcoded secrets/keys
- Weak cryptography
- Missing security headers
- Debug mode enabled
- Insecure configuration

For static findings, output:
```
**Status**: N/A-CPG (Manual Review Required)
**Reason**: Static finding - no data flow to verify
```

### Step 3: Generate/Load CPG

```bash
# Check for cached CPG
CPG_FILE=".joern/$(basename $(pwd)).cpg"

if [ ! -f "$CPG_FILE" ]; then
  echo "[*] Generating CPG (this may take a few minutes)..."
  mkdir -p .joern
  joern-parse . --output "$CPG_FILE"
fi
```

### Step 4: Layer 1 - Joern CPG Verification

Run the appropriate Joern verification script:

```bash
# Select script based on vulnerability type
SCRIPT="${PLUGIN_ROOT}/scripts/joern/verify-${VULN_TYPE}.sc"

# Fallback to generic if specific script not found
if [ ! -f "$SCRIPT" ]; then
  SCRIPT="${PLUGIN_ROOT}/scripts/joern/verify-generic.sc"
fi

# Run verification
joern --script "$SCRIPT" --params cpgFile="$CPG_FILE",file="$FILE",line="$LINE"
```

**Script mapping**:
| Type | Script |
|------|--------|
| `sql-injection` | `verify-sqli.sc` |
| `command-injection` | `verify-cmdi.sc` |
| `xss` | `verify-xss.sc` |
| `path-traversal` | `verify-path.sc` |
| `ssrf` | `verify-ssrf.sc` |
| `*` (other) | `verify-generic.sc` |

**Parse Joern output** (JSON format):
```json
{
  "verdict": "VERIFIED|FALSE_POSITIVE|NEEDS_REVIEW",
  "confidence": 0.0-1.0,
  "reason": "explanation",
  "dataFlow": { "source": {...}, "sink": {...}, "path": [...] },
  "sanitizers": ["list", "of", "sanitizers"]
}
```

### Step 5: Layer 2 - Claude AI Verification

For findings where Joern returns `NEEDS_REVIEW` OR to add additional confidence:

```
Launch the false-positive-verifier agent with:
- Finding: type, file, line
- Joern result: verdict, confidence, reason, dataFlow
- Code context: 20 lines around the sink
```

**Use the Task tool**:
```
subagent_type: "whitebox-pentest:false-positive-verifier"
prompt: |
  Verify this finding:
  - Type: [vuln_type]
  - Location: [file:line]
  - Joern verdict: [verdict] ([confidence]%)
  - Joern reason: [reason]
  - Data flow: [path]

  Code context:
  [20 lines of code around sink]

  Perform 6-step chain-of-thought analysis.
```

### Step 6: Combine Results

**Final verdict logic**:

| Joern Verdict | Claude Verdict | Final Verdict | Action |
|---------------|----------------|---------------|--------|
| VERIFIED | VERIFIED | VERIFIED (HIGH) | Report as true positive |
| VERIFIED | FALSE_POSITIVE | NEEDS_REVIEW | Manual review needed |
| FALSE_POSITIVE | FALSE_POSITIVE | FALSE_POSITIVE | Close finding |
| FALSE_POSITIVE | VERIFIED | NEEDS_REVIEW | Manual review needed |
| NEEDS_REVIEW | VERIFIED | VERIFIED (MEDIUM) | Report with caveat |
| NEEDS_REVIEW | FALSE_POSITIVE | FALSE_POSITIVE | Close finding |
| NEEDS_REVIEW | NEEDS_REVIEW | NEEDS_REVIEW | Manual review required |

**Confidence calculation**:
```
final_confidence = (joern_confidence * 0.6) + (claude_confidence * 0.4)
```

---

## Output Format

### Console Output

```
## Verification Results

### Finding: SQL Injection at routes/login.ts:34

#### Layer 1: Joern CPG Analysis
- **Verdict**: VERIFIED
- **Confidence**: 95%
- **Reason**: User input concatenated into SQL query without parameterization
- **Data Flow**:
  ```
  req.body.email (line 32) [SOURCE]
       ↓
  email variable (line 32)
       ↓
  template literal (line 34)
       ↓
  query() argument (line 34) [SINK]
  ```
- **Sanitizers Found**: None

#### Layer 2: Claude AI Analysis
- **Verdict**: VERIFIED
- **Confidence**: 92%
- **Reasoning**: Template literal directly interpolates user input from req.body.email
  into SQL query string. No parameterization, no escaping, no type coercion.
  The email field accepts arbitrary strings from the HTTP request body.

#### Final Verdict
- **Status**: VERIFIED (TRUE POSITIVE)
- **Combined Confidence**: 94%
- **Action**: Fix immediately - SQL injection vulnerability confirmed

---

### Finding: Path Traversal at routes/download.ts:56

#### Layer 1: Joern CPG Analysis
- **Verdict**: NEEDS_REVIEW
- **Confidence**: 60%
- **Reason**: Possible path normalization detected - verify it prevents traversal

#### Layer 2: Claude AI Analysis
- **Verdict**: FALSE_POSITIVE
- **Confidence**: 85%
- **Reasoning**: path.resolve() is called before readFile(), which normalizes
  the path and resolves any .. sequences. Additionally, the result is checked
  with startsWith() to ensure it remains within the uploads directory.

#### Final Verdict
- **Status**: FALSE_POSITIVE
- **Combined Confidence**: 75%
- **Action**: Close finding - proper path validation in place
```

### Verification Summary Table

```markdown
| Finding | Location | Joern | Claude | Final | Confidence |
|---------|----------|-------|--------|-------|------------|
| SQLi | login.ts:34 | VERIFIED | VERIFIED | TRUE_POSITIVE | 94% |
| PathTrav | download.ts:56 | NEEDS_REVIEW | FALSE_POSITIVE | FALSE_POSITIVE | 75% |
| XSS | profile.ts:89 | VERIFIED | VERIFIED | TRUE_POSITIVE | 91% |
| Hardcoded Key | config.ts:12 | N/A-CPG | - | MANUAL_REVIEW | - |
```

---

## Joern Script Locations

Scripts are located at: `${PLUGIN_ROOT}/scripts/joern/` (detected in Prerequisites section)

| Script | Purpose |
|--------|---------|
| `common.sc` | Shared utilities and patterns |
| `verify-sqli.sc` | SQL injection verification |
| `verify-cmdi.sc` | Command injection verification |
| `verify-xss.sc` | XSS verification |
| `verify-path.sc` | Path traversal verification |
| `verify-ssrf.sc` | SSRF verification |
| `verify-generic.sc` | Generic source-to-sink check |

---

## Vulnerability Type Mapping

| Type Argument | Joern Script | CPG Verifiable |
|---------------|--------------|----------------|
| `sql-injection` | `verify-sqli.sc` | Yes |
| `nosql-injection` | `verify-sqli.sc` | Yes |
| `command-injection` | `verify-cmdi.sc` | Yes |
| `path-traversal` | `verify-path.sc` | Yes |
| `xss` | `verify-xss.sc` | Yes |
| `ssrf` | `verify-ssrf.sc` | Yes |
| `deserialization` | `verify-generic.sc` | Yes |
| `hardcoded-secret` | - | No (N/A-CPG) |
| `weak-crypto` | - | No (N/A-CPG) |
| `missing-header` | - | No (N/A-CPG) |

---

## CPG Caching

To avoid re-parsing on every verification:

```bash
# CPG files are cached in .joern/ directory
.joern/
├── myproject.cpg       # Full project CPG
└── last_updated        # Timestamp of last parse

# Cache is invalidated if source files changed
# Force refresh with --no-cache flag
```

**Cache strategy**:
- Parse once per session
- Reuse for multiple verifications
- Invalidate if `git status` shows changes

---

## Integration with Threat Model

After verification, update threat model:

```markdown
#### T-001: SQL Injection in Login [VERIFIED - 94%]
- **Component**: E-001 Login Endpoint
- **Category**: Tampering
- **Severity**: CRITICAL (25) → CRITICAL-CONFIRMED
- **Location**: routes/login.ts:34
- **Verification**:
  - Joern: VERIFIED (95%)
  - Claude: VERIFIED (92%)
  - Combined: 94%

**Data Flow Path** (Joern):
\`\`\`
req.body.email (line 32) [SOURCE]
    → email variable assignment
    → template literal interpolation
    → query() first argument (line 34) [SINK]
\`\`\`

**AI Analysis** (Claude):
Template literal directly interpolates user input from req.body.email
into SQL query string. No parameterization detected.
```

---

## Notes

- **Joern is required** - No fallback to manual-only verification
- **Claude AI layer is optional** but recommended for NEEDS_REVIEW cases
- CPG generation can be slow (cache is recommended)
- Static findings marked N/A-CPG for manual review
- Two layers agreeing = high confidence
- Two layers disagreeing = manual review needed
