---
name: scan
description: Run automated security scan using Semgrep (default) or multiple tools
argument-hint: "[path] [--tools semgrep,joern] [--rules ruleset] [--workspace name] [--exclude patterns]"
allowed-tools:
  - Bash
  - Glob
  - Read
  - Write
  - TodoWrite
---

# Security Scan

Run automated static analysis to identify security vulnerabilities. Supports Semgrep (default), CodeQL, and Joern.

## Flags

| Flag | Effect |
|------|--------|
| `--tools` | Specify tools: `semgrep`, `codeql`, `joern`, or comma-separated |
| `--rules` | Semgrep ruleset (default: `auto`) |
| `--workspace` | Target specific monorepo workspace |
| `--exclude` | Additional exclusion patterns |
| `--output` | Save findings to JSON file |

## Tool Comparison

| Tool | Strengths | Best For |
|------|-----------|----------|
| **Semgrep** | Fast, pattern-based, low FPs | Known patterns, secrets |
| **CodeQL** | Deep data flow, taint tracking | Complex injection chains |
| **Joern** | Code Property Graph, custom queries | Data flow analysis |

## Prerequisites

```bash
# Check available tools
semgrep --version 2>/dev/null && echo "✓ Semgrep"
codeql version 2>/dev/null && echo "✓ CodeQL"
joern --version 2>/dev/null && echo "✓ Joern"
```

### Installation
```bash
pip install semgrep                    # Semgrep
# CodeQL: https://github.com/github/codeql-cli-binaries/releases
curl -L ".../joern-install.sh" | bash  # Joern
```

## Execution

### Step 1: Determine Scan Scope

Parse scoping arguments:
- `--workspace <name>`: Resolve to packages/[name], apps/[name], etc.
- `--exclude <patterns>`: Additional patterns to exclude
- `path`: Direct path to scan (default: current directory)

### Default Exclusions

Always apply these exclusions:
```bash
--exclude "node_modules" --exclude "vendor" --exclude "dist" \
--exclude "build" --exclude "*.min.js" --exclude "*.map" \
--exclude "__pycache__" --exclude "coverage"
```

### Step 3: Run Semgrep Scan

Execute Semgrep with security-focused rulesets:

```bash
# Auto-detect language and use default security rules
semgrep --config auto --json [path]

# Or use specific security rulesets
semgrep --config p/security-audit --json [path]
semgrep --config p/owasp-top-ten --json [path]
semgrep --config p/cwe-top-25 --json [path]
```

### Step 4: Parse Results

Parse the JSON output and categorize findings:

**Critical/High:**
- Command injection
- SQL injection
- Deserialization
- Code injection

**Medium:**
- XSS vulnerabilities
- Path traversal
- SSRF

**Low/Info:**
- Hardcoded secrets
- Weak cryptography
- Information disclosure

### Step 5: Present Results

Format output as:

```
## Semgrep Security Scan Results

**Target**: [scanned path]
**Rules**: [ruleset used]
**Scan Time**: [duration]

### Critical Findings (X)

#### Finding 1: [rule-id]
- **File**: path/to/file.py:42
- **Rule**: [rule description]
- **CWE**: CWE-XXX
- **Code**:
  ```python
  [vulnerable code snippet]
  ```
- **Fix**: [remediation guidance]

### High Findings (X)
[...]

### Medium Findings (X)
[...]

### Summary
| Severity | Count |
|----------|-------|
| Critical | X     |
| High     | X     |
| Medium   | X     |
| Low      | X     |

### Next Steps
- Use `/whitebox-pentest:trace` to trace data flow for critical findings
- Use code-reviewer agent for manual verification
- Run `/whitebox-pentest:report` to generate full report
```

## Available Rulesets

| Ruleset | Description |
|---------|-------------|
| `auto` | Auto-detect language, use community rules |
| `p/security-audit` | Comprehensive security audit rules |
| `p/owasp-top-ten` | OWASP Top 10 vulnerabilities |
| `p/cwe-top-25` | CWE Top 25 dangerous weaknesses |
| `p/secrets` | Hardcoded secrets detection |
| `p/ci` | CI-friendly security checks |

## Custom Rules

To use custom Semgrep rules:

```bash
semgrep --config /path/to/rules.yaml [target]
```

## Notes

- Semgrep may have false positives - verify findings manually
- Some rules require Semgrep Pro for full functionality
- Use `--exclude` to skip test files or vendor directories
- JSON output is parsed for integration with other commands
