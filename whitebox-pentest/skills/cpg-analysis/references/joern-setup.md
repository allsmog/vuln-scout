# Joern Installation Guide

Quick setup guide for installing Joern for CPG-based verification.

## What is Joern?

Joern is an open-source code analysis platform that creates Code Property Graphs (CPG) from source code, enabling powerful semantic queries for vulnerability detection.

## Requirements

- Java 11+ (OpenJDK recommended)
- 4GB+ RAM (8GB recommended for large codebases)
- ~1GB disk space

## Installation

### macOS (Homebrew)

```bash
# Install Java if needed
brew install openjdk@11

# Install Joern
brew install joern
```

### Linux (Recommended Method)

```bash
# Install Java if needed
sudo apt-get install openjdk-11-jdk  # Debian/Ubuntu
# OR
sudo yum install java-11-openjdk     # RHEL/CentOS

# Download and install Joern
curl -L "https://github.com/joernio/joern/releases/latest/download/joern-install.sh" | bash

# Add to PATH
echo 'export PATH="$HOME/bin/joern:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

### Windows (WSL Recommended)

Use WSL2 with Ubuntu and follow the Linux instructions.

### Manual Installation

```bash
# Download latest release
JOERN_VERSION=$(curl -s https://api.github.com/repos/joernio/joern/releases/latest | grep tag_name | cut -d '"' -f 4)
wget "https://github.com/joernio/joern/releases/download/${JOERN_VERSION}/joern-cli.zip"

# Extract
unzip joern-cli.zip
mv joern-cli ~/joern

# Add to PATH
export PATH="$HOME/joern:$PATH"
```

## Verify Installation

```bash
# Check Joern version
joern --version

# Check joern-parse
joern-parse --help

# Quick test
echo 'function test(x) { return x; }' > /tmp/test.js
joern-parse /tmp/test.js --output /tmp/test.cpg
joern --script <(echo 'loadCpg("/tmp/test.cpg"); println(cpg.method.name.l)')
```

Expected output: `List(test)`

## Language Support

Joern supports these languages via frontends:

| Language | Frontend | Quality |
|----------|----------|---------|
| JavaScript/TypeScript | jssrc2cpg | Good |
| Python | pysrc2cpg | Good |
| Java | javasrc2cpg | Excellent |
| C/C++ | c2cpg | Excellent |
| Go | gosrc2cpg | Good |
| PHP | php2cpg | Good |
| Ruby | rubysrc2cpg | Experimental |
| Kotlin | kotlin2cpg | Good |

### Language Detection

Joern auto-detects language, but you can specify:

```bash
joern-parse /path/to/code --language javascript --output app.cpg
```

## Basic Usage

### Parse Codebase

```bash
# Parse entire directory
joern-parse /path/to/myapp --output myapp.cpg

# Parse specific language
joern-parse /path/to/myapp --language python --output myapp.cpg

# Exclude directories
joern-parse /path/to/myapp --output myapp.cpg --exclude "node_modules,vendor,test"
```

### Run Queries

```bash
# Interactive REPL
joern
> importCpg("myapp.cpg")
> cpg.method.name.l
> cpg.call.name("query").l

# Run script
joern --script analysis.sc --params cpgFile=myapp.cpg
```

### Basic CPGQL Queries

```scala
// List all methods
cpg.method.name.l

// Find calls to specific function
cpg.call.name("query").l

// Find parameters
cpg.parameter.name("req.*").l

// Data flow analysis
val sources = cpg.parameter.name("req")
val sinks = cpg.call.name("query")
sinks.argument.reachableBy(sources).l
```

## Performance Tips

### Memory Configuration

```bash
# Increase heap for large codebases
export JAVA_OPTS="-Xmx8g"
joern-parse /large/codebase --output large.cpg
```

### Exclude Unnecessary Directories

```bash
# Exclude tests, vendors, generated code
joern-parse . --output app.cpg \
  --exclude "node_modules,vendor,dist,build,__pycache__,*.test.*"
```

### CPG Caching

```bash
# Create .joern directory for cache
mkdir -p .joern

# Parse once
joern-parse . --output .joern/app.cpg

# Reuse for multiple queries
joern --script query1.sc --params cpgFile=.joern/app.cpg
joern --script query2.sc --params cpgFile=.joern/app.cpg
```

## Troubleshooting

### Out of Memory

```bash
# Increase heap size
JAVA_OPTS="-Xmx16g" joern-parse /path/to/code --output app.cpg
```

### Slow Parsing

- Exclude `node_modules`, `vendor`, `dist` directories
- Parse only the source directories you need
- Use language-specific frontend for better performance

### Missing Data Flow

- Ensure you're using the correct language flag
- Some complex flows require full project context
- Check that the source file was included in parsing

### Query Errors

```scala
// If query fails, try simpler version first
cpg.call.l  // List all calls

// Then add filters
cpg.call.name("query").l

// Then add data flow
cpg.call.name("query").argument.l
```

## Integration with Plugin

The whitebox-pentest plugin uses Joern via:
- `scripts/joern/*.sc` - Verification scripts
- `.joern/` - CPG cache directory
- `/verify` command - Automated verification

### Plugin Workflow

```bash
# 1. Plugin generates CPG (cached)
joern-parse . --output .joern/app.cpg

# 2. Plugin runs verification script
joern --script verify-sqli.sc --params cpgFile=.joern/app.cpg,file=login.ts,line=34

# 3. Plugin parses JSON output
# {"verdict": "VERIFIED", "confidence": 0.95, ...}
```

## Resources

- [Joern Documentation](https://docs.joern.io/)
- [CPGQL Reference](https://docs.joern.io/cpgql/reference-card/)
- [Joern GitHub](https://github.com/joernio/joern)
- [Query Examples](https://queries.joern.io/)
