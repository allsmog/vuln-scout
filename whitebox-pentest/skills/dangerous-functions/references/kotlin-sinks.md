# Kotlin Dangerous Functions

## Overview

Kotlin runs on the JVM and Android, inheriting Java vulnerabilities while adding some unique patterns. This guide covers both server-side Kotlin and Android-specific security concerns.

---

## Command Execution

| Function/Class | Risk | Notes |
|----------------|------|-------|
| `Runtime.getRuntime().exec()` | Critical | System command run |
| `ProcessBuilder` | Critical | Process spawning |
| `Process.start()` | Critical | Process run |

**Grep Patterns:**
```bash
grep -rniE "(Runtime.*\.exec|ProcessBuilder|\.start\(\))" --include="*.kt" --include="*.kts"
```

**Vulnerable Pattern:**
```kotlin
// VULNERABLE - User input in command
fun runCmd(userInput: String): String {
    val process = Runtime.getRuntime().exec(userInput)
    return process.inputStream.bufferedReader().readText()
}
```

---

## SQL Injection

| Pattern | Risk | Notes |
|---------|------|-------|
| String templates in SQL | Critical | `"SELECT * FROM users WHERE id = $id"` |
| `createQuery()` with concat | High | JPA/Hibernate |
| `createNativeQuery()` | High | Raw SQL |
| `rawQuery()` (Android) | High | SQLite raw query |

**Grep Patterns:**
```bash
# String interpolation in SQL
grep -rniE '(SELECT|INSERT|UPDATE|DELETE).*\$\{?\w+' --include="*.kt"

# JPA queries
grep -rniE "(createQuery|createNativeQuery|rawQuery)" --include="*.kt"
```

**Vulnerable Pattern:**
```kotlin
// VULNERABLE - String interpolation
fun getUser(userId: String): User {
    val query = "SELECT * FROM users WHERE id = '$userId'"
    return entityManager.createNativeQuery(query, User::class.java).singleResult as User
}
```

**Secure Pattern:**
```kotlin
// SECURE - Parameterized query
fun getUser(userId: String): User {
    return entityManager.createQuery(
        "SELECT u FROM User u WHERE u.id = :id", User::class.java
    ).setParameter("id", userId).singleResult
}
```

---

## Deserialization

| Class/Function | Risk | Notes |
|----------------|------|-------|
| `ObjectInputStream.readObject()` | Critical | Java deserialization |
| `XMLDecoder` | Critical | XML deserialization |
| `kotlinx.serialization` | Low | Generally safe |
| `Gson.fromJson()` | Medium | Check type handling |
| `Jackson ObjectMapper` | High | With polymorphism enabled |

**Grep Patterns:**
```bash
grep -rniE "(ObjectInputStream|XMLDecoder|readObject)" --include="*.kt"
grep -rniE "(Gson|ObjectMapper|Json\.decodeFromString)" --include="*.kt"
```

---

## File Operations

| Function | Risk | Notes |
|----------|------|-------|
| `File()` constructor | Medium | Path traversal risk |
| `FileInputStream` | Medium | File read |
| `FileOutputStream` | High | File write |
| `File.readText()` | Medium | Kotlin extension |
| `File.writeText()` | High | Kotlin extension |

**Grep Patterns:**
```bash
grep -rniE "(File\(|FileInputStream|FileOutputStream|\.readText\(|\.writeText\()" --include="*.kt"
```

**Path Traversal:**
```kotlin
// VULNERABLE
fun readUserFile(filename: String): String {
    return File("/uploads/$filename").readText()
}

// SECURE
fun readUserFile(filename: String): String {
    val file = File("/uploads").resolve(filename).canonicalFile
    require(file.path.startsWith("/uploads")) { "Invalid path" }
    return file.readText()
}
```

---

## Android-Specific

### Intent Handling

| Pattern | Risk | Notes |
|---------|------|-------|
| `getIntent().extras` | High | Untrusted Intent data |
| `startActivity(intent)` | Medium | Intent redirection |
| Exported components | High | Accessible by other apps |
| `PendingIntent` | High | If mutable |

**Grep Patterns:**
```bash
grep -rniE "(getIntent\(\)|intent\.(get|extras))" --include="*.kt"
grep -rniE 'android:exported="true"' --include="AndroidManifest.xml"
```

### WebView

| Pattern | Risk | Notes |
|---------|------|-------|
| `setJavaScriptEnabled(true)` | High | XSS risk |
| `addJavascriptInterface()` | Critical | JS bridge attacks |
| `loadUrl()` with user input | High | URL injection |

**Grep Patterns:**
```bash
grep -rniE "(setJavaScriptEnabled|addJavascriptInterface)" --include="*.kt"
grep -rniE "\.loadUrl\(" --include="*.kt"
```

---

## HTTP/Network (SSRF)

| Library | Risk | Notes |
|---------|------|-------|
| `OkHttp` | High | If URL user-controlled |
| `Retrofit` | High | API client |
| `Ktor client` | High | Async HTTP |

**Grep Patterns:**
```bash
grep -rniE "(OkHttpClient|Retrofit|HttpClient)" --include="*.kt"
grep -rniE '(URL\(|"http.*\$)' --include="*.kt"
```

---

## Cryptography

| Pattern | Risk | Notes |
|---------|------|-------|
| Hardcoded keys | Critical | Embedded secrets |
| `Random()` | High | Not cryptographically secure |
| `MD5`/`SHA1` for passwords | High | Weak hashing |

**Grep Patterns:**
```bash
grep -rniE '(secret|key|password|apiKey)\s*=\s*"' --include="*.kt"
grep -rniE "Random\(\)|java\.util\.Random" --include="*.kt"
grep -rniE "(MD5|SHA-1)" --include="*.kt"
```

---

## Spring Framework (Kotlin)

| Pattern | Risk | Notes |
|---------|------|-------|
| `@RequestParam` | High | User input |
| `@PathVariable` | High | URL path input |
| SpEL expressions | Critical | Expression injection |

**Grep Patterns:**
```bash
grep -rniE "(@RequestParam|@PathVariable|@RequestBody)" --include="*.kt"
grep -rniE "(SpelExpressionParser|@Value.*#)" --include="*.kt"
```

---

## Logging (Information Disclosure)

```bash
grep -rniE "(Log\.|logger\.).*\$(password|secret|token)" --include="*.kt"
grep -rniE "Log\.(d|i|w|e|v)\(" --include="*.kt"
```

---

## Testing Checklist

### Server-Side Kotlin
1. [ ] Check SQL queries for injection
2. [ ] Audit command execution
3. [ ] Review deserialization
4. [ ] Check file operations for path traversal
5. [ ] Verify HTTP URL validation

### Android
1. [ ] Review exported components
2. [ ] Check WebView configuration
3. [ ] Audit Intent handling
4. [ ] Review Content Provider queries
5. [ ] Check SharedPreferences for secrets
6. [ ] Verify certificate pinning
