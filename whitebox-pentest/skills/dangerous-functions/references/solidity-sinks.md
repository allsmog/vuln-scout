# Solidity Dangerous Functions (Smart Contract Sinks)

Security-sensitive functions and patterns in Solidity smart contracts. These are primary targets during smart contract security audits.

---

## Reentrancy Sinks (CRITICAL)

Functions that transfer control to external contracts before updating state. This is the #1 smart contract vulnerability class.

### External Calls
```solidity
// CRITICAL - All can trigger reentrancy
.call{value: ...}("")      // Low-level call with ETH - HIGHEST RISK
.call(...)                  // Low-level call
.delegatecall(...)          // Delegatecall (also storage issues)
.staticcall(...)            // Read-only, but can still reenter
.transfer(...)              // 2300 gas limit (safer but not immune)
.send(...)                  // 2300 gas limit, returns bool

// Token callbacks - OFTEN MISSED
safeTransferFrom(...)       // ERC721/1155 - triggers onERC721Received
_safeMint(...)              // ERC721 - triggers receiver hook
tokensReceived(...)         // ERC777 - hook before transfer completes
```

### CEI Pattern (Checks-Effects-Interactions)

**THE KEY DETECTION RULE:** Any state change AFTER an external call is a potential reentrancy vulnerability.

```solidity
// VULNERABLE - External call BEFORE state change
function withdraw(uint amount) external {
    require(balances[msg.sender] >= amount);     // Check
    (bool success, ) = msg.sender.call{value: amount}("");  // Interaction FIRST - BAD!
    require(success);
    balances[msg.sender] -= amount;              // Effect AFTER - VULNERABLE!
}

// SAFE - State change BEFORE external call (CEI Pattern)
function withdraw(uint amount) external {
    require(balances[msg.sender] >= amount);     // Check
    balances[msg.sender] -= amount;              // Effect FIRST - SAFE!
    (bool success, ) = msg.sender.call{value: amount}("");  // Interaction LAST
    require(success);
}
```

### Grep Patterns - Basic Detection
```bash
# Find all external calls (step 1)
grep -rniE "\.call\{value:" --include="*.sol"
grep -rniE "\.call\(|\.delegatecall\(|\.staticcall\(" --include="*.sol"
grep -rniE "\.transfer\(|\.send\(" --include="*.sol"

# Find token callbacks (often missed reentrancy vectors)
grep -rniE "safeTransfer|safeMint|_safeMint" --include="*.sol"
grep -rniE "onERC721Received|onERC1155Received|tokensReceived" --include="*.sol"
```

### Grep Patterns - CEI Violation Detection (CRITICAL)
```bash
# MULTILINE: Find .call followed by state changes (delete, -=, =)
rg -U "\.call\{value:[^}]*\}\s*\([^)]*\)[^;]*;[\s\S]{0,200}(delete\s+\w+|balances\[.*\]\s*[-+]?=|\w+\s*-=)" --glob="*.sol"

# MULTILINE: External call followed by delete statement
rg -U "\.call\{value:.*\}.*\n.*\n.*delete" --glob "*.sol"

# Find functions with BOTH external calls AND state changes (needs manual CEI check)
for f in $(grep -rl "\.call{value:" --include="*.sol"); do
    echo "=== $f ==="
    grep -n "\.call{value:\|delete \|balances\[.*\] -=\|balances\[.*\] =" "$f"
done

# Check for reentrancy guards (mitigations)
grep -rniE "nonReentrant|ReentrancyGuard|modifier.*lock|require.*locked" --include="*.sol"
```

### Vulnerable Patterns Catalog

**Pattern 1: Classic ETH Drain**
```solidity
// BAD: delete/update after external call
function withdraw(uint amount) external {
    require(balances[msg.sender] >= amount);
    (bool success, ) = msg.sender.call{value: amount}("");
    require(success);
    balances[msg.sender] -= amount;  // VULNERABLE - attacker reenters before this
}
```

**Pattern 2: ERC721 Callback Reentrancy**
```solidity
// BAD: safeTransferFrom triggers onERC721Received before state update
function claimNFT(uint tokenId) external {
    require(claims[tokenId] == msg.sender);
    nft.safeTransferFrom(address(this), msg.sender, tokenId);  // Callback here!
    delete claims[tokenId];  // VULNERABLE - attacker claims twice
}
```

**Pattern 3: Cross-Function Reentrancy**
```solidity
// BAD: Attacker reenters transfer() while withdraw() is executing
function withdraw() external {
    uint amount = balances[msg.sender];
    (bool success, ) = msg.sender.call{value: amount}("");
    balances[msg.sender] = 0;  // Other functions see stale balance
}

function transfer(address to, uint amt) external {
    require(balances[msg.sender] >= amt);  // Uses stale balance during reentry!
    balances[msg.sender] -= amt;
    balances[to] += amt;
}
```

### Safe Patterns

**Safe Pattern 1: CEI (Checks-Effects-Interactions)**
```solidity
function withdraw(uint amount) external {
    require(balances[msg.sender] >= amount);  // CHECK
    balances[msg.sender] -= amount;           // EFFECT (before external call)
    (bool success, ) = msg.sender.call{value: amount}("");  // INTERACTION (last)
    require(success);
}
```

**Safe Pattern 2: ReentrancyGuard**
```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract Vault is ReentrancyGuard {
    function withdraw(uint amount) external nonReentrant {
        // Even with bad ordering, nonReentrant prevents reentry
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success);
        balances[msg.sender] -= amount;
    }
}
```

### Joern CPG Verification
```bash
# Verify a specific reentrancy finding
joern --script verify-reentrancy.sc --params cpgFile=contracts.cpg,file=Vault.sol,line=45

# Scan entire file for reentrancy patterns
joern --script verify-reentrancy.sc --params cpgFile=contracts.cpg,file=Vault.sol --command scanFile
```

---

## Access Control Sinks (CRITICAL)

### tx.origin Authentication
```solidity
// CRITICAL - Phishing vulnerable
tx.origin    // Never use for authentication
```

### Missing Access Control
```solidity
// Check public/external functions for missing modifiers
function (external|public)  // Without onlyOwner, onlyRole, etc.
```

### Grep Patterns
```bash
# tx.origin usage (almost always bad)
grep -rniE "tx\.origin" --include="*.sol"

# Functions without access control
grep -rniE "function\s+\w+\s*\([^)]*\)\s*(external|public)" --include="*.sol" | grep -v "view\|pure\|onlyOwner\|onlyRole\|require.*msg\.sender"

# Privileged functions
grep -rniE "(selfdestruct|suicide|delegatecall|setOwner|transferOwnership|pause|unpause|mint|burn|upgrade)" --include="*.sol"
```

---

## Arithmetic Sinks (CRITICAL for <0.8.0)

### Overflow/Underflow (Pre-Solidity 0.8)
```solidity
// Check pragma version first
pragma solidity ^0.7.0;  // VULNERABLE to overflow
pragma solidity ^0.8.0;  // Safe by default (reverts on overflow)

// Dangerous in <0.8.0
+   // Addition overflow
-   // Subtraction underflow
*   // Multiplication overflow
**  // Exponentiation overflow
```

### Grep Patterns
```bash
# Check Solidity version
grep -rniE "pragma solidity.*0\.[0-7]\." --include="*.sol"

# Unchecked blocks (even in 0.8+)
grep -rniE "unchecked\s*\{" --include="*.sol"

# Type casting (can truncate)
grep -rniE "uint8\(|uint16\(|uint32\(|int8\(|int16\(" --include="*.sol"
```

---

## Delegatecall Sinks (CRITICAL)

### Storage Collision
```solidity
// CRITICAL - Can overwrite storage
.delegatecall(...)  // Executes in caller's context

// Dangerous patterns
address(impl).delegatecall(data)  // Proxy pattern - check storage layout
```

### Grep Patterns
```bash
# All delegatecall usage
grep -rniE "\.delegatecall\(" --include="*.sol"

# Proxy patterns
grep -rniE "(fallback|receive).*delegatecall" --include="*.sol"
grep -rniE "_implementation|_delegate|upgradeTo" --include="*.sol"
```

---

## Selfdestruct Sinks (CRITICAL)

```solidity
// CRITICAL - Destroys contract, sends ETH
selfdestruct(address)
suicide(address)  // Deprecated alias
```

### Grep Patterns
```bash
grep -rniE "(selfdestruct|suicide)\s*\(" --include="*.sol"
```

---

## External Data Sinks (HIGH)

### Oracle Manipulation
```solidity
// Price oracles - check for manipulation
latestRoundData()      // Chainlink
latestAnswer()         // Chainlink (deprecated)
getPrice()             // Custom oracles
getReserves()          // Uniswap spot price (manipulable)
```

### Grep Patterns
```bash
# Oracle usage
grep -rniE "(latestRoundData|latestAnswer|getPrice|getReserves|oracle)" --include="*.sol"

# Single-block price checks (flash loan vulnerable)
grep -rniE "block\.(timestamp|number)" --include="*.sol"
```

---

## Randomness Sinks (HIGH)

### Insecure Randomness
```solidity
// INSECURE - Miner/validator manipulable
block.timestamp
block.number
block.difficulty  // Deprecated post-merge
block.prevrandao  // Post-merge, still somewhat predictable
blockhash(...)    // Only last 256 blocks, predictable
```

### Grep Patterns
```bash
grep -rniE "block\.(timestamp|number|difficulty|prevrandao)" --include="*.sol"
grep -rniE "blockhash\s*\(" --include="*.sol"
grep -rniE "keccak256.*block\." --include="*.sol"
```

---

## Signature Sinks (HIGH)

### ECDSA Issues
```solidity
// Signature verification
ecrecover(...)       // Returns address(0) on failure - must check!
ECDSA.recover(...)   // OpenZeppelin - safer but check usage

// Signature malleability
// v, r, s can be manipulated to create different valid signatures
```

### Grep Patterns
```bash
# ecrecover usage
grep -rniE "ecrecover\s*\(" --include="*.sol"

# Signature functions
grep -rniE "(recover|verify).*signature" --include="*.sol"

# Missing zero-address check after ecrecover
grep -rniE "ecrecover" --include="*.sol" -A 3 | grep -v "require.*!= address\(0\)"
```

---

## Low-Level Calls (HIGH)

### Assembly Usage
```solidity
// Inline assembly - bypasses safety checks
assembly { ... }

// Dangerous assembly patterns
mstore(...)   // Memory manipulation
sstore(...)   // Storage manipulation
call(...)     // Low-level call
create(...)   // Contract creation
create2(...)  // Deterministic creation
```

### Grep Patterns
```bash
# Assembly blocks
grep -rniE "assembly\s*\{" --include="*.sol"

# Specific dangerous opcodes
grep -rniE "(mstore|sstore|mload|sload|call|delegatecall|create|create2)" --include="*.sol"
```

---

## Token Sinks (HIGH)

### Approval Issues
```solidity
// Unlimited approval
approve(address, type(uint256).max)
approve(address, uint256(-1))       // Pre-0.8 style

// Transfer hooks (reentrancy via ERC777/ERC1155)
safeTransferFrom(...)  // Can call receiver hook
_safeMint(...)         // Can call receiver hook
```

### Grep Patterns
```bash
# Unlimited approvals
grep -rniE "approve\(.*type\(uint256\)\.max|approve\(.*\-1\)" --include="*.sol"

# Safe transfers (potential reentrancy)
grep -rniE "safeTransfer|_safeMint|_safeTransfer" --include="*.sol"

# Token hooks
grep -rniE "onERC721Received|onERC1155Received|tokensReceived" --include="*.sol"
```

---

## Storage Sinks (MEDIUM)

### Uninitialized Storage
```solidity
// Uninitialized storage pointer (pre-0.5.0)
struct Data { ... }
Data data;  // Points to storage slot 0!
```

### Grep Patterns
```bash
# Storage keyword
grep -rniE "storage\s+\w+\s*;" --include="*.sol"

# Struct declarations without initialization
grep -rniE "struct.*\{" --include="*.sol" -A 10
```

---

## Gas Sinks (MEDIUM)

### Denial of Service
```solidity
// Unbounded loops
for (uint i = 0; i < array.length; i++)  // If array grows, DoS

// External calls in loops
for (...) { address.call(...); }  // One failure breaks all

// Block gas limit
gasleft()  // Check for gas griefing
```

### Grep Patterns
```bash
# Loops over dynamic arrays
grep -rniE "for\s*\(.*\.length" --include="*.sol"

# External calls in loops
grep -rniE "for.*\{" --include="*.sol" -A 10 | grep -E "\.call|\.transfer|\.send"
```

---

## Input Validation Sinks (MEDIUM)

### Missing Zero-Address Checks
```solidity
// Should validate address != address(0)
function setOwner(address _owner) external {
    owner = _owner;  // Missing validation!
}
```

### Grep Patterns
```bash
# Functions with address parameters
grep -rniE "function.*\(.*address\s+\w+" --include="*.sol"

# Check for missing zero-address validation
grep -rniE "function.*address" --include="*.sol" -A 5 | grep -v "require.*!= address\(0\)"
```

---

## Flash Loan Sinks (HIGH)

### Single-Transaction Manipulation
```solidity
// Vulnerable to flash loan attacks
balanceOf(...)         // Can be manipulated within tx
totalSupply()          // Can change within tx
getReserves()          // Uniswap reserves manipulable
```

### Grep Patterns
```bash
# Balance checks (potential flash loan targets)
grep -rniE "balanceOf\(|totalSupply\(|getReserves\(" --include="*.sol"

# Price calculations
grep -rniE "(price|rate|ratio).*=.*balance" --include="*.sol"
```

---

## Quick Reference Table

| Category | Functions | Severity | CWE |
|----------|-----------|----------|-----|
| Reentrancy | `.call`, `.send`, `.transfer` | CRITICAL | CWE-841 |
| Access Control | `tx.origin`, missing modifiers | CRITICAL | CWE-284 |
| Arithmetic | `+`, `-`, `*` (pre-0.8) | CRITICAL | CWE-190 |
| Delegatecall | `.delegatecall` | CRITICAL | CWE-829 |
| Selfdestruct | `selfdestruct` | CRITICAL | CWE-400 |
| Oracle | `latestRoundData`, `getPrice` | HIGH | CWE-807 |
| Randomness | `block.timestamp`, `blockhash` | HIGH | CWE-330 |
| Signature | `ecrecover` | HIGH | CWE-347 |
| Assembly | `assembly { }` | HIGH | CWE-676 |
| Token | `approve`, `safeTransfer` | HIGH | CWE-362 |
| Gas/DoS | unbounded loops | MEDIUM | CWE-400 |
| Flash Loan | `balanceOf`, spot prices | HIGH | CWE-362 |

---

## Automated Scanning

For automated scanning, use Slither for fast pattern detection:

```bash
# Install Slither
pip install slither-analyzer

# Run Slither on contracts
slither contracts/

# Or via plugin
/whitebox-pentest:scan contracts/ --tools semgrep
```
